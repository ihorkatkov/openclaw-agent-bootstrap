# OpenClaw Agent Bootstrap

## What This Project Is

A Docker-based bootstrap template for deploying OpenClaw AI agents. It provides a single `./setup.sh` script that handles image building, configuration, interactive onboarding (provider + channel setup), and launches a gateway service. Target: get an AI agent running in ~5 minutes.

## Tech Stack

- **Bash** — `setup.sh` (interactive setup wizard)
- **Docker Compose v2** — service orchestration (`docker-compose.yml`)
- **GNU Make** — command shortcuts (`Makefile`)
- **Node.js** — OpenClaw runtime (inside Docker image, not in this repo)

## Architecture

Two Docker Compose services from the same OpenClaw image:

1. **gateway** (always-on) — `node dist/index.js gateway --bind lan --port 18789`
   - Receives messages from channels (Telegram, WhatsApp, Discord, Signal)
   - Routes to configured LLM providers (Anthropic, OpenAI, Google, xAI)
   - Executes agent workflows
   - Ports: 18789 (gateway), 18790 (bridge)

2. **cli** (on-demand, profile: `cli`) — `node dist/index.js <command>`
   - Onboarding wizard, model/channel management
   - Interactive TTY, runs via `make cli CMD="..."`

## Project Structure

```
├── setup.sh                 # Interactive setup wizard (bash)
├── docker-compose.yml       # Gateway + CLI service definitions
├── Makefile                 # Developer command shortcuts
├── README.md                # User documentation
├── LICENSE                  # MIT
├── .gitignore
├── extensions/              # Plugin directory (auto-discovered, mounted into container)
│   └── aegis/               # Bidirectional firewall plugin
├── .env                     # GENERATED, gitignored — runtime config with credentials
└── .openclaw/               # GENERATED, gitignored — runtime data
    ├── openclaw.json        # Agent configuration
    ├── .env                 # OpenClaw-specific env vars
    ├── agents/              # Agent definitions
    └── workspace/           # Execution workspace and state
```

## Key Commands

```bash
./setup.sh              # First-time interactive setup
make start              # Start gateway container
make stop               # Stop all services
make restart            # Restart gateway
make logs               # Follow gateway logs
make status             # Container + model status
make doctor             # Validate prerequisites and config
make shell              # Shell into gateway container
make onboard            # Re-run onboarding wizard
make cli CMD="..."      # Run OpenClaw CLI commands
make clean              # Remove containers and volumes
```

## Configuration

- `.env` — generated by `setup.sh` with mode 600. Contains:
  - `COMPOSE_PROJECT_NAME`, `OPENCLAW_IMAGE`, `OPENCLAW_GATEWAY_TOKEN` (256-bit hex)
  - Gateway host/port/bind settings, config/workspace paths
- `.openclaw/` — persistent runtime state, agent configs, workspace
- `docker-compose.override.yml` / `docker-compose.extra.yml` — optional, gitignored

## Security Model

- Gateway token: 256-bit hex generated via `openssl rand` or `python3 secrets`
- `.env` file: mode 600 (owner-only read/write)
- Default network bind: `127.0.0.1` (localhost only)
- All credentials in gitignored paths (`.env`, `.openclaw/`)

## Aegis Firewall Plugin (`extensions/aegis/`)

A bidirectional firewall plugin that protects agents from secret leakage and dangerous tool calls. Loaded automatically via the `extensions/` volume mount — no `loadPaths` config needed.

### What It Does

- **Vault**: Bidirectional secret store — model uses `{{PLACEHOLDER}}` syntax, Aegis injects real values outbound and scrubs them inbound
- **Gatekeeper**: Per-tool allow/deny regex rules on outbound tool calls (e.g. block `rm -rf /`, restrict file write paths, deny SSRF URLs)
- **Sanitizer**: Regex-based secret detection on inbound tool results (catches `sk-`, `ghp_`, Bearer tokens, PEM blocks, etc.)
- **System prompt hint**: Tells the model about available placeholders and blocked-call guidance

### 4 Hooks

1. `before_tool_call` (priority 100) — gatekeeper check + vault injection
2. `tool_result_persist` (priority 100, sync) — vault scrub + pattern sanitize on tool results
3. `before_agent_start` (priority 50) — inject system prompt context
4. `message_sending` (priority 50) — scrub secrets from outgoing channel messages

### Configuration

Set in `openclaw.json` under `plugins.entries.aegis.config`:
- `vault` — `Record<string, string>` of placeholder name → real secret value
- `sanitization` — `{ enabled, useDefaultPatterns, extraPatterns, replacement }`
- `rules` — `{ defaults: ToolRuleSet, tools: Record<string, ToolRuleSet> }` with per-param allow/deny
- `systemPromptHint` — inject model context (default: true)
- `logBlocked` — log blocked calls (default: true)

### File Structure

```
extensions/aegis/
├── openclaw.plugin.json       # Plugin manifest with JSON Schema
├── package.json               # Package metadata
├── index.ts                   # Entry point — registers 4 hooks
└── src/
    ├── types.ts               # AegisConfig type
    ├── defaults.ts            # Default secure rules
    ├── vault.ts               # Bidirectional secret vault
    ├── sanitizer.ts           # Regex-based secret detection
    ├── gatekeeper.ts          # Per-tool allow/deny rule engine
    ├── patterns.ts            # Shared regex patterns + tool groups
    └── system-prompt.ts       # System prompt context builder
```

## Development Notes

- The OpenClaw application code lives in a separate repo (github.com/openclaw/openclaw) — this repo is only the deployment template
- The Docker image (`openclaw:local`) must be pre-built or built from source during setup
- `setup.sh` handles tilde expansion for source paths and sanitizes project names to valid Docker Compose names
- Token generation falls back from openssl to python3
- The CLI service uses `BROWSER: echo` env var to suppress browser-open attempts in Docker
